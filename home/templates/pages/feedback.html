{% extends 'layouts/base.html' %}
{% load static i18n %}
{% block content %}
  <!-- Horizontal Progress Bar (hidden by default) -->
  <div id="topLoadingBar"
       class="progress"
       style="display: none;
              height: 4px">
    <div id="topLoadingBarProgress"
         class="progress-bar progress-bar-striped progress-bar-animated"
         role="progressbar"
         style="width: 0%"></div>
  </div>
  <div class="container-fluid py-4">
    <!-- Task Header -->
    <div class="feedback-task-header p-3 mb-3 text-center shadow-sm">
      <h3 class="mb-2" id="taskTitle">{{ feedback.task.title }}</h3>
      <p id="taskDescription" class="mb-0">
        {{ feedback.task.description|linebreaks }}
      </p>
    </div>
    <div class="row feedback-row">
      <!-- User Solution Form Section -->
      <div id="userSolutionSection" class="col-12 col-lg-6 mb-3 user-solution-section">
        <div class="card user-solution-card shadow-sm h-100">
          <div class="card-body">
            <h5 id="userSolutionTitle" class="card-title text-center mb-3">{% trans 'Your Solution' %}</h5>
            <form id="userSolutionForm" method="post" class="user-solution-form mb-3">
              {% csrf_token %}
              <div id="solutionFormFields" class="mb-3">
                {% for field in form %}
                  <div class="mb-3" id="formGroup_{{ field.name }}">
                    {{ field }}
                    {% if field.help_text %}<small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                  </div>
                {% endfor %}
              </div>
              <button id="generateFeedbackButton"
                      class="btn btn-primary w-100 mt-3"
                      type="submit">{% trans 'Accept notes of use and generate feedback' %}</button>
              <div id="feedbackDisclaimer" class="feedback-disclaimer mt-3">
                <small class="text-muted">
                  <strong>{% trans 'Important:' %}</strong>
                  {% trans 'The feedback is generated by generative AI. The results may contain errors or be invented by the system. Check all statements critically before using them.' %}
                  <br><br>
                  {% blocktrans %}
By exchanging messages with COFFEE, you agree to our 
<a href="/policies/" class="text-primary">Notes of Use</a> 
and confirm that you have read our <a href="/policies/" class="text-primary">Disclaimer</a>.
{% endblocktrans %}
                </small>
              </div>
              <input type="hidden"
                     id="feedbackCourseId"
                     value="{{ feedbackcriteria_set.0.feedback.course.id }}" />
              <input type="hidden"
                     id="feedbackUuidInput"
                     value="{{ feedbackcriteria_set.0.feedback.id }}" />
            </form>
          </div>
        </div>
      </div>
      <!-- Feedback Section -->
      <div id="feedbackSections" class="col-12 col-lg-6 mb-3 feedback-sections">
        <div id="feedbackContainer"
             data-username="{{ request.user.username|default:'' }}"></div>
        <!-- NPS Rating Section (now a bar of segments) -->
        <div id="npsContainer" class="card feedback-card nps-container shadow-sm mb-3">
          <div class="card-body text-center">
            <h5 class="card-title">{% trans 'How helpful was this feedback for you?' %}</h5>
            <!-- NPS Bar -->
            <div id="npsBar"
                 class="nps-bar d-flex justify-content-center align-items-center my-3 flex-wrap">
              {% for score in scores %}<div class="nps-segment mx-1" data-score="{{ score }}">{{ score }}</div>{% endfor %}
            </div>
            <div class="d-flex justify-content-between mt-3">
              <small>{% trans 'Not helpful at all' %}</small>
              <small>{% trans 'Very helpful' %}</small>
            </div>
          </div>
        </div>
        {% for feedback in feedbackcriteria_set.all %}
          <div id="feedbackSection_{{ feedback.criteria.id }}"
               class="card feedback-card shadow-sm mb-3 feedback-section"
               data-criteria-id="{{ feedback.criteria.id }}"
               data-llm="{{ feedback.criteria.llm }}">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 id="criteriaTitle_{{ feedback.criteria.id }}" class="mb-0">{{ feedback.criteria.title }}</h5>
              <button id="infoButton_{{ feedback.criteria.id }}"
                      class="btn btn-sm btn-outline-primary"
                      data-bs-toggle="offcanvas"
                      data-bs-target="#offcanvas{{ feedback.criteria.id }}"
                      aria-controls="offcanvas{{ feedback.criteria.id }}">{% trans 'Info' %}</button>
            </div>
            <div class="card-body">
              <textarea id="aiResponse_{{ feedback.criteria.id }}"
                        class="form-control ai-response"
                        name="aiResponse_{{ feedback.criteria.id }}"
                        rows="6"
                        disabled></textarea>
            </div>
            <!-- Offcanvas for Criteria Info -->
            <div class="offcanvas offcanvas-end"
                 tabindex="-1"
                 id="offcanvas{{ feedback.criteria.id }}"
                 aria-labelledby="offcanvasLabel{{ feedback.criteria.id }}">
              <div class="offcanvas-header">
                <h5 id="offcanvasLabel_{{ feedback.criteria.id }}"
                    class="offcanvas-title">{{ feedback.criteria.title }}</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="offcanvas"
                        aria-label="Close"></button>
              </div>
              <div class="offcanvas-body">
                <p id="criteriaDescription_{{ feedback.criteria.id }}">{{ feedback.criteria.description }}</p>
                <hr>
                <h6>{% trans 'Prompt' %}</h6>
                <p id="criteriaPrompt_{{ feedback.criteria.id }}">{{ feedback.criteria.prompt }}</p>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% include 'includes/footer.html' %}
{% endblock %}
{% block scripts %}
  <script>
  $(document).ready(function () {
    // Initialize feedbackData
    var feedbackData = {
      user_input: null,
      task: {
        id: "{{ feedbackcriteria_set.0.feedback.task.id|escapejs }}",
        title: "{{ feedbackcriteria_set.0.feedback.task.title|escapejs }}"
      },
      criteria: [],
      nps_score: null
    };

    // Handle form submission
    $('#userSolutionForm').submit(function (event) {
      event.preventDefault();
      var userInput = $('#id_submission').val().trim();
      var uuid = $('#feedbackUuidInput').val().trim();
      var courseId = $('#feedbackCourseId').val().trim();
      feedbackData.user_input = userInput;
      feedbackData.feedback_id = uuid;
      feedbackData.course_id = courseId;

      // 1) Show top loading bar immediately with 100% width
      $('#topLoadingBar').show();
      $('#topLoadingBarProgress').css('width', '100%');

      // Clear old AI responses
      $('.ai-response').val('');
      feedbackData.criteria = [];

      var $feedbackSections = $('.feedback-section');
      var totalRequests = $feedbackSections.length;
      var completedRequests = 0;

      $feedbackSections.each(function () {
        var criteriaId = $(this).data('criteria-id');
        var criteriaTitle = $('#criteriaTitle_' + criteriaId).text();
        var criteriaLlm = $(this).data('llm');
        var responseField = $('#aiResponse_' + criteriaId);

        // Prepare criteria in feedbackData
        feedbackData.criteria.push({
          id: criteriaId,
          title: criteriaTitle,
          ai_response: '',
          llm: criteriaLlm
        });

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/feedback_stream/' + uuid + '/' + criteriaId + '/', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');

        xhr.onprogress = function () {
          var partialResponse = xhr.responseText;
          responseField.val(partialResponse);
        };

        xhr.onload = function () {
          if (xhr.status === 200) {
            var response = xhr.responseText;
            var criterion = feedbackData.criteria.find(function(c){
              return c.id === criteriaId;
            });
            if (criterion) criterion.ai_response = response;
          } else {
            responseField.val('An error occurred. Please try again.');
          }
        };

        xhr.onerror = function () {
          console.error('Error fetching response for criteria ' + criteriaId);
          responseField.val('Error fetching response.');
        };

        xhr.onloadend = function () {
          // 2) We no longer update the progress % each time,
          //    but we do count requests to know when all are done.
          completedRequests++;
          if (completedRequests === totalRequests) {
            // 3) Hide the progress bar once all requests are done
            $('#topLoadingBar').fadeOut();
            saveFeedbackSession(feedbackData);
          }
        };

        xhr.timeout = 120000;
        xhr.send('user_input=' + encodeURIComponent(userInput));
      });
    });

    // Handle NPS score selection: now uses .nps-segment
    document.querySelectorAll('.nps-segment').forEach(function (segment) {
      segment.addEventListener('click', function () {
        // Remove 'nps-selected' from all segments
        document.querySelectorAll('.nps-segment').forEach(function (seg) {
          seg.classList.remove('nps-selected');
        });
        // Add 'nps-selected' to the clicked segment
        this.classList.add('nps-selected');

        // Set the selected score and save
        feedbackData.nps_score = this.dataset.score;
        saveFeedbackSession(feedbackData);
      });
    });
  });

  // Save feedback session
  function saveFeedbackSession(feedbackData) {
    $.ajax({
      url: '/save_feedback_session/',
      method: 'POST',
      data: JSON.stringify({ feedback_data: feedbackData }),
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      success: function (response) {
        // Session saved successfully
      },
      error: function (error) {
        // Handle error in saving session
      }
    });
  }
  </script>
{% endblock %}
