{% extends 'layouts/base.html' %}
{% load i18n %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-end mb-4">
    <div>
      <h2 class="mb-1">{% trans "Sprachmodell-Zuordnungen" %}</h2>
      <p class="text-muted small mb-0">
        {% trans "Überblick, welche Kriterien und Aufgaben welchen Sprachmodellen zugeordnet sind." %}
      </p>
    </div>
  </div>

  {% if visible_course_count == 0 %}
    <div class="alert alert-warning" role="alert">
      {% trans "Für Ihre Nutzergruppe sind derzeit keine Kurse freigeschaltet." %}
    </div>
  {% elif not llm_hierarchy %}
    <div class="alert alert-info" role="alert">
      {% trans "Es liegen noch keine Zuordnungen von Kriterien zu Sprachmodellen vor." %}
    </div>
  {% else %}
    <div class="accordion" id="llm-accordion">
      {% for llm_block in llm_hierarchy %}
        {% with accordion_id=forloop.counter %}
          <div class="accordion-item mb-3">
            <h2 class="accordion-header" id="heading-{{ accordion_id }}">
              <button class="accordion-button collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapse-{{ accordion_id }}"
                      aria-expanded="false"
                      aria-controls="collapse-{{ accordion_id }}">
                <div class="d-flex flex-column flex-md-row flex-md-wrap w-100 gap-2 justify-content-between">
                  <div class="me-2">
                    <div class="fw-semibold">
                      {{ llm_block.llm.provider.name }} — {{ llm_block.llm.name }}
                    </div>
                    <div class="text-muted small">
                      {{ llm_block.llm.external_name }}
                    </div>
                  </div>
                  <div class="text-muted small d-flex gap-3 align-items-center">
                    <span class="badge bg-light text-dark">
                      {{ llm_block.course_count }} {% blocktrans count llm_block.course_count as course_count %}
                      Kurs{% plural %}Kurse{% endblocktrans %}
                    </span>
                    <span class="badge bg-light text-dark">
                      {{ llm_block.criteria_count }} {% blocktrans count llm_block.criteria_count as criteria_count %}
                      Kriterium{% plural %}Kriterien{% endblocktrans %}
                    </span>
                  </div>
                </div>
              </button>
            </h2>
            <div id="collapse-{{ accordion_id }}"
                 class="accordion-collapse collapse"
                 aria-labelledby="heading-{{ accordion_id }}"
                 data-bs-parent="#llm-accordion">
              <div class="accordion-body">
                {% for course_block in llm_block.courses %}
                  <div class="mb-4 pb-4 {% if not forloop.last %}border-bottom{% endif %}">
                    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-start mb-3">
                      <div>
                        <h5 class="mb-1">
                          {{ course_block.course.course_name }}
                        </h5>
                        <div class="text-muted small">
                          {{ course_block.course.faculty }}
                          {% if course_block.course.term %}
                            · {{ course_block.course.term }}
                          {% endif %}
                        </div>
                      </div>
                      <div class="text-muted small d-flex gap-3 align-items-center">
                        <span>
                          {{ course_block.task_count }} {% blocktrans count course_block.task_count as task_count %}
                          Aufgabe{% plural %}Aufgaben{% endblocktrans %}
                        </span>
                        <span>
                          {{ course_block.criteria_count }} {% blocktrans count course_block.criteria_count as criteria_count %}
                          Kriterium{% plural %}Kriterien{% endblocktrans %}
                        </span>
                      </div>
                    </div>

                    {% if course_block.tasks %}
                      <div class="list-group list-group-flush">
                        {% for task_block in course_block.tasks %}
                          <div class="list-group-item px-0">
                            <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
                              <div>
                                <div class="fw-semibold">
                                  {{ task_block.task.title }}
                                </div>
                                {% if task_block.task.description %}
                                  <div class="text-muted small text-truncate" style="max-width: 420px;">
                                    {{ task_block.task.description }}
                                  </div>
                                {% endif %}
                              </div>
                              <div>
                                {% if task_block.task.active %}
                                  <span class="badge bg-success">{% trans "aktiv" %}</span>
                                {% else %}
                                  <span class="badge bg-secondary">{% trans "inaktiv" %}</span>
                                {% endif %}
                              </div>
                            </div>
                            <ul class="list-unstyled ms-0 mt-3 mb-0 small">
                              {% for entry in task_block.criteria %}
                                <li class="d-flex flex-wrap align-items-center gap-2 mb-1">
                                  {% if entry.rank %}
                                    <span class="badge bg-primary fw-semibold">
                                      {% trans "Rang" %} {{ entry.rank }}
                                    </span>
                                  {% endif %}
                                  <span class="fw-semibold">{{ entry.criterion.title }}</span>
                                  {% if entry.criterion.active == False %}
                                    <span class="badge bg-warning">{% trans "inaktiv" %}</span>
                                  {% endif %}
                                  {% if entry.criterion.tag %}
                                    <span class="badge bg-light text-dark">{{ entry.criterion.tag }}</span>
                                  {% endif %}
                                </li>
                              {% endfor %}
                            </ul>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <div class="alert alert-secondary mb-0" role="alert">
                        {% trans "Für diesen Kurs sind derzeit keine Aufgaben mit diesem Sprachmodell verknüpft." %}
                      </div>
                    {% endif %}

                    {% if course_block.unassigned %}
                      <div class="alert alert-light border-start border-3 border-warning mt-3 mb-0" role="alert">
                        <div class="fw-semibold mb-2">
                          {% trans "Kriterien ohne Aufgabe" %}
                        </div>
                        <ul class="mb-0 ps-3">
                          {% for criterion in course_block.unassigned %}
                            <li class="mb-1">
                              {{ criterion.title }}
                              {% if criterion.active == False %}
                                <span class="badge bg-warning">{% trans "inaktiv" %}</span>
                              {% endif %}
                              {% if criterion.tag %}
                                <span class="badge bg-light text-dark">{{ criterion.tag }}</span>
                              {% endif %}
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endwith %}
      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock content %}
