{% extends 'layouts/base.html' %}
{% load static i18n %}
{% block content %}
<!-- Horizontal Progress Bar (hidden by default) -->
<div id="topLoadingBar"
     class="progress"
     style="display: none;
              height: 4px">
    <div id="topLoadingBarProgress"
         class="progress-bar progress-bar-striped progress-bar-animated"
         role="progressbar"
         style="width: 0%"></div>
</div>
<div class="container-fluid py-4">
    <!-- Task Header -->
    <div class="feedback-task-header p-3 mb-3 text-center shadow-sm">
        <h3 class="mb-2" id="taskTitle">{{ feedback.task.title }}</h3>
        <p id="taskDescription" class="mb-0">
            {{ feedback.task.description|linebreaks }}
        </p>
    </div>
    <div class="row feedback-row">
        <!-- User Solution Form Section -->
        <div id="userSolutionSection" class="col-12 col-lg-6 mb-3 user-solution-section">
            <div class="card user-solution-card shadow-sm h-100">
                <div class="card-body">
                    <h5 id="userSolutionTitle" class="card-title text-center mb-3">{% trans 'Your Solution' %}</h5>
                    <form id="userSolutionForm" method="post" class="user-solution-form mb-3">
                        {% csrf_token %}
                        <div id="solutionFormFields" class="mb-3">
                            {% for field in form %}
                            <div class="mb-3" id="formGroup_{{ field.name }}">
                                {{ field }}
                                {% if field.help_text %}<small class="form-text text-muted">{{ field.help_text
                                }}</small>{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <button id="generateFeedbackButton"
                                class="btn btn-primary w-100 mt-3"
                                type="submit">{% trans 'Accept notes of use and generate feedback' %}
                        </button>
                        <div id="feedbackDisclaimer" class="feedback-disclaimer mt-3">
                            <small class="text-muted">
                                <strong>{% trans 'Important:' %}</strong>
                                {% trans 'The feedback is generated by generative AI. The results may contain errors or
                                be invented by the system. Check all statements critically before using them.' %}
                                <br><br>
                                {% blocktrans %}
                                By exchanging messages with COFFEE, you agree to our
                                <a href="/policies/" class="text-primary">Notes of Use</a>
                                and confirm that you have read our <a href="/policies/"
                                                                      class="text-primary">Disclaimer</a>.
                                {% endblocktrans %}
                            </small>
                        </div>
                        <input type="hidden"
                               id="feedbackCourseId"
                               value="{{ feedbackcriteria_set.0.feedback.course.id }}"/>
                        <input type="hidden"
                               id="feedbackUuidInput"
                               value="{{ feedbackcriteria_set.0.feedback.id }}"/>
                    </form>
                </div>
            </div>
        </div>
        <!-- Feedback Section -->
        <div id="feedbackSections" class="col-12 col-lg-6 mb-3 feedback-sections">
            <div id="feedbackContainer"
                 data-username="{{ request.user.username|default:'' }}"></div>
            <!-- Helpfulness Score Rating Section (now a bar of segments) -->
            <div id="npsContainer" class="card feedback-card nps-container shadow-sm mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title">{% trans 'How helpful was this feedback for you?' %}</h5>
                    <!-- Helpfulness Score Bar -->
                    <div id="npsBar"
                         class="nps-bar d-flex justify-content-center align-items-center my-3 flex-wrap">
                        {% for score in scores %}
                        <div class="nps-segment mx-1" data-score="{{ score }}">{{ score }}</div>
                        {% endfor %}
                    </div>
                    <div class="d-flex justify-content-between mt-3">
                        <small>{% trans 'Not helpful at all' %}</small>
                        <small>{% trans 'Very helpful' %}</small>
                    </div>
                </div>
            </div>

            {% for feedback in feedbackcriteria_set.all %}
            <div id="feedbackSection_{{ feedback.criteria.id }}"
                 class="card feedback-card shadow-sm mb-3 feedback-section"
                 data-criteria-id="{{ feedback.criteria.id }}"
                 data-llm-id="{{ feedback.criteria.llm_fk.id|default_if_none:'' }}"
                 data-llm-external="{{ feedback.criteria.llm_fk.external_name|default_if_none:''|escape }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 id="criteriaTitle_{{ feedback.criteria.id }}" class="mb-0">{{ feedback.criteria.title }}</h5>
                    <button id="infoButton_{{ feedback.criteria.id }}"
                            class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="offcanvas"
                            data-bs-target="#offcanvas{{ feedback.criteria.id }}"
                            aria-controls="offcanvas{{ feedback.criteria.id }}">{% trans 'Info' %}
                    </button>
                </div>
                <div class="card-body">
              <textarea id="aiResponse_{{ feedback.criteria.id }}"
                        class="form-control ai-response"
                        name="aiResponse_{{ feedback.criteria.id }}"
                        rows="10"
                        disabled></textarea>
                </div>
            </div>
            {% endfor %}

            <!-- Download PDF Card (always visible at bottom) -->
            <div id="downloadSection" class="card feedback-card shadow-sm mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title">{% trans 'Download Your Feedback' %}</h5>
                    <p class="text-muted">{% trans 'Save your feedback as a PDF document' %}</p>
                    <button id="downloadPdfBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-download me-2"></i>{% trans 'Download PDF' %}
                    </button>
                    <div id="downloadStatus" class="mt-2">
                        <small class="text-muted">{% trans 'Complete the feedback process to enable download' %}</small>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Offcanvas elements moved outside card containers for full height -->
{% for feedback in feedbackcriteria_set.all %}
<div class="offcanvas offcanvas-end"
     tabindex="-1"
     id="offcanvas{{ feedback.criteria.id }}"
     aria-labelledby="offcanvasLabel{{ feedback.criteria.id }}">
    <div class="offcanvas-header">
        <h5 id="offcanvasLabel_{{ feedback.criteria.id }}"
            class="offcanvas-title">{{ feedback.criteria.title }}</h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <p id="criteriaDescription_{{ feedback.criteria.id }}">{{ feedback.criteria.description }}</p>
        <hr>
        <h6>{% trans 'Prompt' %}</h6>
        <p id="criteriaPrompt_{{ feedback.criteria.id }}">{{ feedback.criteria.prompt }}</p>
    </div>
</div>
{% endfor %}
{% include 'includes/footer.html' %}
{% endblock %}
{% block scripts %}
<script>
  $(document).ready(function () {
    // ---------------------------
    // Init: payload for saving
    // ---------------------------
    var feedbackData = {
      user_input: null,
      task: {
        id: "{{ feedbackcriteria_set.0.feedback.task.id|escapejs }}",
        title: "{{ feedbackcriteria_set.0.feedback.task.title|escapejs }}"
      },
      criteria: [],
      helpfulness_score: null
    };

    // -------------------------------------------------
    // Submit: generate feedback for all criteria/cards
    // -------------------------------------------------
    $('#userSolutionForm').on('submit', function (event) {
      event.preventDefault();

      var userInput = $('#id_submission').val().trim();
      var uuid = $('#feedbackUuidInput').val().trim();
      var courseId = $('#feedbackCourseId').val().trim();

      feedbackData.user_input = userInput;
      feedbackData.feedback_id = uuid;
      feedbackData.course_id = courseId;

      // Top loading bar
      $('#topLoadingBar').show();
      $('#topLoadingBarProgress').css('width', '100%');

      // Disable download while generating
      $('#downloadPdfBtn').prop('disabled', true);
      $('#downloadStatus').html(
        '<small class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>{% trans "Generating feedback..." %}</small>'
      );

      // Clear old responses & criteria array
      $('.ai-response').val('');
      feedbackData.criteria = [];

      var $feedbackSections = $('.feedback-section');
      var totalRequests = $feedbackSections.length;
      var completedRequests = 0;

      // Edge case: no criteria
      if (totalRequests === 0) {
        $('#topLoadingBar').fadeOut();
        $('#downloadStatus').html('<small class="text-warning"><i class="fas fa-star me-1"></i>{% trans "Please rate the feedback to enable download" %}</small>');
        saveFeedbackSession(feedbackData);
        return;
      }

      // For each criterion card start one stream request
      $feedbackSections.each(function () {
        var $section = $(this);

        // Read data-* attributes (jQuery maps data-llm-id -> llmId usw.)
        var criteriaId = $section.data('criteriaId') ?? $section.data('criteria-id');
        var criteriaTitle = $('#criteriaTitle_' + criteriaId).text();
        var criteriaLlmId = $section.data('llmId') ?? null;               // from data-llm-id
        var criteriaLlmExternal = $section.data('llmExternal') ?? null;   // from data-llm-external
        var responseField = $('#aiResponse_' + criteriaId);

        // Prepare entry in feedbackData
        feedbackData.criteria.push({
          id: criteriaId,
          title: criteriaTitle,
          ai_response: '',
          llm_model_id: criteriaLlmId,
          llm_external_name: criteriaLlmExternal
        });

        // --- Start async IIFE for this criterion ---
        (async () => {
          const responseFieldStart = responseField.val() || '';
          let acc = responseFieldStart;

          // Build POST body
          const formData = new URLSearchParams();
          formData.append('user_input', userInput);
          // Optional: send LLM info if backend wants it
          if (criteriaLlmId) formData.append('llm_model_id', criteriaLlmId);
          if (criteriaLlmExternal) formData.append('llm_external_name', criteriaLlmExternal);

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 600000); // 10 min

          try {
            const res = await fetch(`/feedback-stream/${uuid}/${criteriaId}/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
              },
              body: formData.toString(),
              signal: controller.signal
            });

            if (!res.ok || !res.body) {
              const errText = await res.text();
              responseField.val(errText || 'An error occurred. Please try again.');
              return;
            }

            // --- Minimal SSE parser ---
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buf = '';
            let curEvent = 'message';
            let curData = [];

            const dispatch = (event, dataStr) => {
              let payload = null;
              try { payload = dataStr ? JSON.parse(dataStr) : null; } catch {}
              switch (event) {
                case 'delta':
                  if (payload?.text) {
                    acc += payload.text;
                    responseField.val(acc);
                  }
                  break;
                case 'usage': {
                  const criterion = feedbackData.criteria.find(c => c.id === criteriaId);
                  if (criterion) criterion.usage = payload;
                  break;
                }
                case 'error':
                  console.error('SSE error event', payload);
                  break;
                case 'end':
                  // nothing special to do
                  break;
                default:
                  break;
              }
            };

            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              buf += decoder.decode(value, { stream: true });

              let nl;
              while ((nl = buf.indexOf('\n')) !== -1) {
                const line = buf.slice(0, nl);
                buf = buf.slice(nl + 1);

                const trimmed = line.replace(/\r$/, '');
                if (trimmed === '') {
                  if (curData.length > 0) dispatch(curEvent, curData.join('\n'));
                  curEvent = 'message';
                  curData = [];
                  continue;
                }
                if (trimmed.startsWith(':')) continue; // comment/heartbeat

                const colon = trimmed.indexOf(':');
                const field = colon === -1 ? trimmed : trimmed.slice(0, colon);
                const rawVal = colon === -1 ? '' : trimmed.slice(colon + 1);
                const valueStr = rawVal.startsWith(' ') ? rawVal.slice(1) : rawVal;

                if (field === 'event') {
                  curEvent = valueStr || 'message';
                } else if (field === 'data') {
                  curData.push(valueStr);
                }
              }
            }

            // Flush remaining event
            if (curData.length > 0) dispatch(curEvent, curData.join('\n'));

            // Save final text into payload
            const criterion = feedbackData.criteria.find(c => c.id === criteriaId);
            if (criterion) criterion.ai_response = acc;

          } catch (err) {
            console.error('Stream error for criteria', criteriaId, err);
            responseField.val('Error fetching response.');
          } finally {
            clearTimeout(timeoutId);
            completedRequests++;
            if (completedRequests === totalRequests) {
              $('#topLoadingBar').fadeOut();
              $('#downloadStatus').html('<small class="text-warning"><i class="fas fa-star me-1"></i>{% trans "Please rate the feedback to enable download" %}</small>');
              saveFeedbackSession(feedbackData);
            }
          }
        })();
        // --- end IIFE ---
      }); // end each
    }); // end submit

    // ---------------------------------------
    // NPS / Helpfulness: clickable segments
    // ---------------------------------------
    document.querySelectorAll('.nps-segment').forEach(function (segment) {
      segment.addEventListener('click', function () {
        document.querySelectorAll('.nps-segment').forEach(function (seg) {
          seg.classList.remove('nps-selected');
        });
        this.classList.add('nps-selected');

        feedbackData.helpfulness_score = this.dataset.score;
        saveFeedbackSession(feedbackData);
      });
    });

    // ---------------------------
    // Download PDF handler
    // ---------------------------
    $('#downloadPdfBtn').on('click', function () {
      var sessionId = $(this).data('session-id');
      if (sessionId) {
        window.location.href = '/feedback/' + sessionId + '/download/';
      }
    });
  }); // end document.ready

  // ---------------------------------------
  // Ajax: save feedback session
  // ---------------------------------------
  function saveFeedbackSession(feedbackData) {
    $.ajax({
      url: '/save-feedback-session/',
      method: 'POST',
      data: JSON.stringify({ feedback_data: feedbackData }),
      contentType: 'application/json',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      success: function (response) {
        if (response.session_id) {
          $('#downloadPdfBtn').prop('disabled', false);
          $('#downloadPdfBtn').data('session-id', response.session_id);
          $('#downloadStatus').html('<small class="text-success"><i class="fas fa-check me-1"></i>{% trans "Ready to download" %}</small>');
        }
      },
      error: function (error) {
        console.error('Failed to save feedback session', error);
      }
    });
  }
</script>
{% endblock %}

