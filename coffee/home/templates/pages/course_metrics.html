{% extends 'layouts/base.html' %}
{% load i18n %}
{% load humanize %}
{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-3">{% trans "Course Metrics" %} {% trans "per selected time range" %}</h2>

    <!-- Filter -->
    <form id="metrics-filter" method="get" class="row g-3 align-items-end mb-3">
        <div class="col-12 col-md-6">
            <label for="course_id" class="form-label">{% trans "Select course" %}</label>
            <select id="course_id" name="course_id" class="form-select" onchange="this.form.submit()">
                {% for c in courses %}
                {% if c.id|stringformat:"s" == selected_course_id|stringformat:"s" %}
                <option value="{{ c.id }}" selected>{{ c.name }}</option>
                {% else %}
                <option value="{{ c.id }}">{{ c.name }}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>

        <div class="col-12 col-md-3">
            <label class="form-label">{% trans "Start" %}</label>
            <input type="datetime-local"
                   class="form-control"
                   name="start"
                   value="{{ start|date:'c'|slice:':16' }}"
                   onchange="this.form.submit()">
        </div>

        <div class="col-12 col-md-3">
            <label class="form-label">{% trans "End" %}</label>
            <input type="datetime-local"
                   class="form-control"
                   name="end"
                   value="{{ end|date:'c'|slice:':16' }}"
                   onchange="this.form.submit()">
        </div>
    </form>

    <!-- KPIs -->
    <div class="row g-4 mb-3">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="text-uppercase text-muted small">{% trans "Sessions (total)" %}</div>
                    <div class="h3 mb-0">{{ kpi.total_sessions|intcomma:True|default:"–" }}</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="text-uppercase text-muted small">{% trans "Tokens (total)" %}</div>
                    <div class="h3 mb-0">{{ kpi.total_tokens|intcomma:True|default:"–" }}</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="text-uppercase text-muted small">{% trans "Avg helpfulness" %}</div>
                    <div class="h3 mb-0">
                        {% if kpi.avg_helpfulness is not None %}
                        {{ kpi.avg_helpfulness|floatformat:2 }}
                        {% else %}–{% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="text-uppercase text-muted small">{% trans "Avg duration (s)" %}</div>
                    <div class="h3 mb-0">
                        {% if kpi.avg_duration_seconds is not None %}
                        {{ kpi.avg_duration_seconds|floatformat:1 }}
                        {% else %}–{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end mb-4">
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <label class="form-label">{% trans "Time range" %}</label>
                    <select class="form-select" name="bucket" onchange="this.form.submit()" form="metrics-filter">
                        <option value="day" {% if bucket == 'day' %}selected{% endif %}>{% trans "per day" %}</option>
                        <option value="week" {% if bucket == 'week' %}selected{% endif %}>{% trans "per week" %}</option>
                        <option value="month" {% if bucket == 'month' %}selected{% endif %}>{% trans "per month" %}</option>
                    </select>
                </div>
            </div>

            <!-- Tabelle A: Aufrufe pro Zeitraum (Sessions) -->
            <h5 class="mb-3">{% trans "Views" %}</h5>
            <div class="chart-wrap" style="height:220px;">
                <canvas id="calls_line_chart"></canvas>
            </div>
        </div>
        {{ calls_rows|json_script:"calls-data" }}
    </div>
    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
  <!-- Ø Tokens pro Aufgabe -->
  <div class="col">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column">
        <h5 class="mb-3">{% trans "Avg tokens per feedback" %}</h5>
        <div class="chart-wrap p-3 flex-grow-1" style="height:260px;">
          <canvas id="avg_tokens_task_chart"></canvas>
        </div>
        {% if not avg_tokens_per_task %}
          <div class="text-muted small mt-2">{% trans "No data." %}</div>
        {% endif %}
      </div>
    </div>
    {{ avg_tokens_per_task|json_script:"avg-tokens-task-data" }}
  </div>

  <!-- Ø Helpfulness pro Aufgabe -->
  <div class="col">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column">
        <h5 class="mb-3">{% trans "Avg helpfulness per feedback" %}</h5>
        <div class="chart-wrap p-3 flex-grow-1" style="height:260px;">
          <canvas id="avg_help_task_chart"></canvas>
        </div>
        {% if not avg_help_per_task %}
          <div class="text-muted small mt-2">{% trans "No data." %}</div>
        {% endif %}
      </div>
    </div>
    {{ avg_help_per_task|json_script:"avg-help-task-data" }}
  </div>

  <!-- Aufrufe pro Aufgabe -->
  <div class="col">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column">
        <h5 class="mb-3">{% trans "Views per feedback" %}</h5>
        <div class="chart-wrap p-3 flex-grow-1" style="height:260px;">
          <canvas id="calls_per_task_chart"></canvas>
        </div>
        {% if not calls_per_task %}
          <div class="text-muted small mt-2">{% trans "No data." %}</div>
        {% endif %}
      </div>
    </div>
    {{ calls_per_task|json_script:"calls-per-task-data" }}
  </div>


    </div>
    <div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="mb-3">{% trans "Helpfulness coverage per task" %}</h5>

    <div class="table-responsive">
      <table class="table table-sm table-striped table-hover align-middle w-100">
        <thead class="table-light">
          <tr>
            <th>{% trans "Task" %}</th>
              <th class="text-end">{% trans "with_score_perc" %}</th>
            <th class="text-end">{% trans "without_score_perc" %}</th>
            <th class="text-end">{% trans "With score" %}</th>
            <th class="text-end">{% trans "Without score" %}</th>
              <th class="text-end">{% trans "Total" %}</th>


          </tr>
        </thead>
        <tbody>
          {% for r in help_coverage_per_task %}
            <tr>
              <td class="text-break" style="max-width: 420px;">{{ r.task }}</td>
                <td class="text-end">{{ r.pct_with|floatformat:1 }}%</td>
                <td class="text-end">{{ r.pct_without|floatformat:1 }}%</td>
              <td class="text-end">{{ r.with_help|intcomma }}</td>
              <td class="text-end">{{ r.without_help|intcomma }}</td>
              <td class="text-end">{{ r.total|intcomma }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">— {% trans "No data." %} —</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
</div>
{% endblock content %}

{% block scripts %}
{{ block.super }}
<!-- Chart.js + Date-Adapter (für Zeitachse) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
    function renderCallsChart() {
      const canvas = document.getElementById('calls_line_chart');
      const dataEl = document.getElementById('calls-data');
      if (!canvas || !dataEl) return;

      // Guard: nicht mehrfach initialisieren
      if (canvas.dataset.chartInitialized === "1") {
        // Aktualisieren statt neu bauen? Dann hier ggf. .data neu setzen + update()
        if (window.callsChart) window.callsChart.update();
        return;
      }

      const ctx = canvas.getContext('2d');

      // Falls noch ein Chart existiert → sauber zerstören
      if (window.callsChart) {
        window.callsChart.destroy();
        window.callsChart = null;
      }

      const raw = JSON.parse(dataEl.textContent || '[]');
      const points = raw.map(r => ({ x: r.bucket, y: r.count }));
      const currentBucket = "{{ bucket }}";
      const locale =
        document.documentElement?.lang
        || (typeof navigator !== 'undefined' ? navigator.language : 'en');

      const bucketUnit = currentBucket === "week" ? "week" : currentBucket === "month" ? "month" : "day";
      const xScaleOptions = {
        type: 'time',
        time: {
          unit: bucketUnit,
          displayFormats: {
            day: 'dd.MM',
            week: 'dd.MM',
            month: 'MMMM'
          }
        },
        ticks: {
          source: 'data'
        },
        title: { display: false }
      };

      if (currentBucket === "month") {
        xScaleOptions.ticks.callback = function(value) {
          let timestamp = typeof value === 'number' ? value : Date.parse(value);
          if (Number.isNaN(timestamp) && typeof this?.getLabelForValue === 'function') {
            const resolved = this.getLabelForValue(value);
            timestamp = Date.parse(resolved);
            if (Number.isNaN(timestamp)) {
              return resolved;
            }
          }
          if (Number.isNaN(timestamp)) {
            return value;
          }
          return new Intl.DateTimeFormat(locale, { month: 'long' }).format(new Date(timestamp));
        };
      }

      const formatTooltipTitle = (timestamp) => {
        if (!timestamp || Number.isNaN(timestamp)) {
          return "";
        }
        const date = new Date(timestamp);
        if (currentBucket === "month") {
          return new Intl.DateTimeFormat(locale, { month: 'long', year: 'numeric' }).format(date);
        }
        if (currentBucket === "week") {
          return new Intl.DateTimeFormat(locale, { day: '2-digit', month: 'long', year: 'numeric' }).format(date);
        }
        return new Intl.DateTimeFormat(locale, { day: '2-digit', month: 'long', year: 'numeric' }).format(date);
      };

      window.callsChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: '{% trans "Views" %}',
            data: points,
            borderWidth: 2,
            pointRadius: 2,
            fill: false,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,   // WICHTIG, wenn die Höhe per CSS kommt
          animation: false,            // kein Flackern
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: xScaleOptions,
            y: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: '{% trans "Views" %}' } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => {
                  if (!items || !items.length) return "";
                  const ts = items[0].parsed?.x;
                  return formatTooltipTitle(ts);
                }
              }
            }
          }
        }
      });

      // Markiere als initialisiert
      canvas.dataset.chartInitialized = "1";
    }

    // Events: DOMContentLoaded (Seitenlade), plus htmx/turbo wenn du sie nutzt
    document.addEventListener('DOMContentLoaded', renderCallsChart, { once: true });
    document.addEventListener('htmx:afterSwap', () => {
      // nach partial swaps neu rendern
      renderCallsChart();
    });
    document.addEventListener('turbo:load', () => {
      renderCallsChart();
    });

    function renderAvgTokensPerTaskChart() {
    const canvas = document.getElementById('avg_tokens_task_chart');
    const dataEl = document.getElementById('avg-tokens-task-data');
    if (!canvas || !dataEl) return;

    // Prevent double init
    if (canvas.dataset.chartInitialized === "1") {
      if (window.avgTokensTaskChart) window.avgTokensTaskChart.update();
      return;
    }

    const raw = JSON.parse(dataEl.textContent || '[]');
    const locale =
      document.documentElement?.lang
      || (typeof navigator !== 'undefined' ? navigator.language : 'en');
    const normalized = raw.slice().sort((a, b) => (a.task || '').localeCompare(b.task || '', locale, { sensitivity: 'base' }));
    const labels = normalized.map(r => r.task);
    const values = normalized.map(r => r.avg_tokens);

    // Destroy previous chart if any
    if (window.avgTokensTaskChart) {
      window.avgTokensTaskChart.destroy();
      window.avgTokensTaskChart = null;
    }

    const ctx = canvas.getContext('2d');
    window.avgTokensTaskChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '{% trans "Avg tokens per feedback" %}',
          data: values,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        animation: false,
        indexAxis: 'y', // horizontale Balken – besser für lange Aufgabennamen
        scales: {
          x: {
            beginAtZero: true,
            ticks: { precision: 0 },
            title: { display: true, text: '{% trans "Tokens" %}' }
          },
          y: {
            title: { display: false }
          }
        },
        plugins: { legend: { display: false } }
      }
    });

    canvas.dataset.chartInitialized = "1";
  }

  function renderAvgHelpPerTaskChart() {
    const canvas = document.getElementById('avg_help_task_chart');
    const dataEl = document.getElementById('avg-help-task-data');
    if (!canvas || !dataEl) return;

    if (canvas.dataset.chartInitialized === "1") {
      if (window.avgHelpTaskChart) window.avgHelpTaskChart.update();
      return;
    }

    const raw = JSON.parse(dataEl.textContent || '[]');
    const locale =
      document.documentElement?.lang
      || (typeof navigator !== 'undefined' ? navigator.language : 'en');
    const normalized = raw.slice().sort((a, b) => (a.task || '').localeCompare(b.task || '', locale, { sensitivity: 'base' }));
    const labels = normalized.map(r => r.task);
    const values = normalized.map(r => r.avg_helpfulness); // can be null

    if (window.avgHelpTaskChart) {
      window.avgHelpTaskChart.destroy();
      window.avgHelpTaskChart = null;
    }

    const ctx = canvas.getContext('2d');
    window.avgHelpTaskChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '{% trans "Avg helpfulness" %}',
          data: values,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        animation: false,
        indexAxis: 'y',
        scales: {
          x: {
            min: 0,
            max: 10,
            title: { display: true, text: '{% trans "Helpfulness" %}' }
          },
          y: {
            title: { display: false }
          }
        },
        plugins: { legend: { display: false } }
      }
    });

    canvas.dataset.chartInitialized = "1";
  }

  function renderCallsPerTaskChart() {
    const canvas = document.getElementById('calls_per_task_chart');
    const dataEl = document.getElementById('calls-per-task-data');
    if (!canvas || !dataEl) return;

    if (canvas.dataset.chartInitialized === "1") {
      if (window.callsPerTaskChart) window.callsPerTaskChart.update();
      return;
    }

    const raw = JSON.parse(dataEl.textContent || '[]');
    const locale =
      document.documentElement?.lang
      || (typeof navigator !== 'undefined' ? navigator.language : 'en');
    const normalized = raw.slice().sort((a, b) => (a.task || '').localeCompare(b.task || '', locale, { sensitivity: 'base' }));
    const labels = normalized.map(r => r.task);
    const values = normalized.map(r => r.count);

    if (window.callsPerTaskChart) {
      window.callsPerTaskChart.destroy();
      window.callsPerTaskChart = null;
    }

    const ctx = canvas.getContext('2d');
    window.callsPerTaskChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '{% trans "Views" %}',
          data: values,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        animation: false,
        indexAxis: 'y', // horizontal; besser für lange Aufgabennamen
        scales: {
          x: {
            beginAtZero: true,
            ticks: { precision: 0 },
            title: { display: true, text: '{% trans "Views" %}' }
          },
          y: {
            title: { display: false }
          }
        },
        plugins: { legend: { display: false } }
      }
    });

    canvas.dataset.chartInitialized = "1";
  }

  // Hooks ergänzen (du hast die anderen schon eingetragen)
  document.addEventListener('DOMContentLoaded', () => {
    renderCallsChart();
    renderAvgTokensPerTaskChart();
    renderAvgHelpPerTaskChart();
    renderCallsPerTaskChart();
  }, { once: true });

  document.addEventListener('htmx:afterSwap', () => {
    renderCallsChart();
    renderAvgTokensPerTaskChart();
    renderAvgHelpPerTaskChart();
    renderCallsPerTaskChart();
  });

  document.addEventListener('turbo:load', () => {
    renderCallsChart();
    renderAvgTokensPerTaskChart();
    renderAvgHelpPerTaskChart();
    renderCallsPerTaskChart();
  });
</script>
{% endblock scripts %}
